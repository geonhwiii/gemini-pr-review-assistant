#!/bin/bash

# Gemini APIë¥¼ ì‚¬ìš©í•œ AI PR ë¦¬ë·° ë° ë¶„ì„ ë„êµ¬ (GitHub PR ì—°ë™)

# ì„¤ì • íŒŒì¼ ìœ„ì¹˜
CONFIG_FILE="$HOME/.gemini-pr-review-config.json"

# ì„¤ì • íŒŒì¼ ì½ê¸° í•¨ìˆ˜
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        LANGUAGE=$(cat "$CONFIG_FILE" | grep -o '"language":"[^"]*"' | cut -d'"' -f4)
        [ -z "$LANGUAGE" ] && LANGUAGE="ko"
    else
        LANGUAGE=""
    fi
}

# ì„¤ì • íŒŒì¼ ì €ì¥ í•¨ìˆ˜
save_config() {
    local lang=$1
    mkdir -p "$(dirname "$CONFIG_FILE")"
    echo '{"language":"'$lang'"}' > "$CONFIG_FILE"
}

# ì–¸ì–´ë³„ ë©”ì‹œì§€ í•¨ìˆ˜
msg() {
    local key=$1
    local param1=$2
    local param2=$3
    case "$LANGUAGE" in
        "en")
            case "$key" in
                "welcome") echo "ğŸ” AI PR Review CLI - AI-powered pull request review and analysis" ;;
                "help_usage") echo "Usage:" ;;
                "help_review") echo "  aipr                    # Review current branch PR" ;;
                "help_branch") echo "  aipr <branch>           # Review specific branch PR" ;;
                "help_diff") echo "  aipr --diff <base>      # Compare with specific base branch" ;;
                "help_post") echo "  aipr --post-comment     # Post review as PR comment" ;;
                "help_options") echo "Options:" ;;
                "help_branch_desc") echo "  <branch>                # Target branch to review" ;;
                "help_diff_desc") echo "  --diff <base>           # Compare with base branch (default: main)" ;;
                "help_post_desc") echo "  --post-comment          # Post AI review as GitHub PR comment" ;;
                "help_configure_desc") echo "  --configure             # Configure language settings" ;;
                "help_version_desc") echo "  --version, -v           # Show version information" ;;
                "help_help_desc") echo "  --help, -h              # Show help" ;;
                "help_example") echo "Examples:" ;;
                "help_example_current") echo "  aipr                    # Review current branch" ;;
                "help_example_branch") echo "  aipr feature/login      # Review feature/login branch" ;;
                "help_example_diff") echo "  aipr --diff develop     # Compare current branch with develop" ;;
                "help_example_post") echo "  aipr --post-comment     # Review and post comment to PR" ;;
                "unknown_option") echo "âŒ Unknown option:" ;;
                "usage_help") echo "Usage: aipr [branch] [--diff base] [--configure] [--help|-h]" ;;
                "not_git_repo") echo "âŒ Not a Git repository." ;;
                "gemini_not_installed") echo "âš ï¸  Gemini CLI is not installed or not authenticated. Please follow these steps:
   1. Install: npm install -g @google/gemini-cli
   2. Authenticate: gemini (follow the authentication prompts)" ;;
                "current_branch") echo "ğŸ“ Current branch: $param1" ;;
                "analyzing_branch") echo "ğŸ“ Analyzing branch changes..." ;;
                "analyzing_diff") echo "ğŸ“ Analyzing differences between $param1 and $param2..." ;;
                "ai_reviewing") echo "ğŸ¤– AI is reviewing the PR..." ;;
                "ai_review_complete") echo "ğŸ¯ AI PR Review Complete:" ;;
                "no_changes") echo "ğŸ“Š No changes found between branches." ;;
                "review_summary") echo "ğŸ“‹ Review Summary:" ;;
                "security_issues") echo "ğŸ”’ Security Issues:" ;;
                "performance_issues") echo "âš¡ Performance Issues:" ;;
                "code_quality") echo "âœ¨ Code Quality:" ;;
                "suggestions") echo "ğŸ’¡ Suggestions:" ;;
                "gh_not_installed") echo "âš ï¸  GitHub CLI is not installed. Install it to enable PR integration:
   brew install gh  # or visit https://cli.github.com" ;;
                "no_pr_found") echo "ğŸ“ No PR found for current branch. Creating review based on branch diff." ;;
                "pr_found") echo "ğŸ“ Found PR #$param1: $param2" ;;
                "debug_pr_search") echo "ğŸ” Searching for PR for branch: $param1" ;;
                "posting_comment") echo "ğŸ“ Posting review as PR comment..." ;;
                "comment_posted") echo "âœ… Review comment posted to PR successfully!" ;;
                "comment_failed") echo "âŒ Failed to post comment to PR." ;;
                "configure_title") echo "ğŸŒ Language Configuration" ;;
                "configure_current") echo "ğŸ“ Current language: $param1" ;;
                "configure_select") echo "ğŸ”¤ Select language / ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”:" ;;
                "configure_korean") echo "  1. í•œêµ­ì–´ (Korean)" ;;
                "configure_english") echo "  2. English" ;;
                "configure_prompt") echo "Enter choice (1-2): " ;;
                "configure_success") echo "âœ… Language set to: $param1" ;;
                "configure_invalid") echo "âŒ Invalid choice. Please select 1 or 2." ;;
                "first_run_title") echo "ğŸ‰ Welcome to AI PR Review Assistant!" ;;
                "first_run_subtitle") echo "First-time setup" ;;
                "first_run_desc") echo "Please select your preferred language for UI and review messages:" ;;
                *) echo "$key" ;;
            esac
            ;;
        *)
            case "$key" in
                "welcome") echo "ğŸ” AI PR Review CLI - AI ê¸°ë°˜ í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¦¬ë·° ë° ë¶„ì„ ë„êµ¬" ;;
                "help_usage") echo "ì‚¬ìš©ë²•:" ;;
                "help_review") echo "  aipr                    # í˜„ì¬ ë¸Œëœì¹˜ PR ë¦¬ë·°" ;;
                "help_branch") echo "  aipr <ë¸Œëœì¹˜>           # íŠ¹ì • ë¸Œëœì¹˜ PR ë¦¬ë·°" ;;
                "help_diff") echo "  aipr --diff <ë² ì´ìŠ¤>    # íŠ¹ì • ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ë¹„êµ" ;;
                "help_post") echo "  aipr --post-comment     # ë¦¬ë·°ë¥¼ PR ëŒ“ê¸€ë¡œ ì‘ì„±" ;;
                "help_options") echo "ì˜µì…˜:" ;;
                "help_branch_desc") echo "  <ë¸Œëœì¹˜>                # ë¦¬ë·°í•  ëŒ€ìƒ ë¸Œëœì¹˜" ;;
                "help_diff_desc") echo "  --diff <ë² ì´ìŠ¤>         # ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ë¹„êµ (ê¸°ë³¸ê°’: main)" ;;
                "help_post_desc") echo "  --post-comment          # AI ë¦¬ë·°ë¥¼ GitHub PR ëŒ“ê¸€ë¡œ ì‘ì„±" ;;
                "help_configure_desc") echo "  --configure             # ì–¸ì–´ ì„¤ì • ë³€ê²½" ;;
                "help_version_desc") echo "  --version, -v           # ë²„ì „ ì •ë³´ í‘œì‹œ" ;;
                "help_help_desc") echo "  --help, -h              # ë„ì›€ë§ í‘œì‹œ" ;;
                "help_example") echo "ì˜ˆì‹œ:" ;;
                "help_example_current") echo "  aipr                    # í˜„ì¬ ë¸Œëœì¹˜ ë¦¬ë·°" ;;
                "help_example_branch") echo "  aipr feature/login      # feature/login ë¸Œëœì¹˜ ë¦¬ë·°" ;;
                "help_example_diff") echo "  aipr --diff develop     # í˜„ì¬ ë¸Œëœì¹˜ì™€ develop ë¹„êµ" ;;
                "help_example_post") echo "  aipr --post-comment     # ë¦¬ë·°í•˜ê³  PRì— ëŒ“ê¸€ ì‘ì„±" ;;
                "unknown_option") echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜:" ;;
                "usage_help") echo "ì‚¬ìš©ë²•: aipr [ë¸Œëœì¹˜] [--diff ë² ì´ìŠ¤] [--configure] [--help|-h]" ;;
                "not_git_repo") echo "âŒ Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤." ;;
                "gemini_not_installed") echo "âš ï¸  Gemini CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ì£¼ì„¸ìš”:
   1. ì„¤ì¹˜: npm install -g @google/gemini-cli
   2. ì¸ì¦: gemini (ì¸ì¦ ê³¼ì •ì„ ë”°ë¼ ì™„ë£Œí•˜ì„¸ìš”)" ;;
                "current_branch") echo "ğŸ“ í˜„ì¬ ë¸Œëœì¹˜: $param1" ;;
                "analyzing_branch") echo "ğŸ“ ë¸Œëœì¹˜ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•©ë‹ˆë‹¤..." ;;
                "analyzing_diff") echo "ğŸ“ $param1ê³¼ $param2 ê°„ì˜ ì°¨ì´ì ì„ ë¶„ì„í•©ë‹ˆë‹¤..." ;;
                "ai_reviewing") echo "ğŸ¤– AIê°€ PRì„ ë¦¬ë·° ì¤‘ì…ë‹ˆë‹¤..." ;;
                "ai_review_complete") echo "ğŸ¯ AI PR ë¦¬ë·° ì™„ë£Œ:" ;;
                "no_changes") echo "ğŸ“Š ë¸Œëœì¹˜ ê°„ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤." ;;
                "review_summary") echo "ğŸ“‹ ë¦¬ë·° ìš”ì•½:" ;;
                "security_issues") echo "ğŸ”’ ë³´ì•ˆ ì´ìŠˆ:" ;;
                "performance_issues") echo "âš¡ ì„±ëŠ¥ ì´ìŠˆ:" ;;
                "code_quality") echo "âœ¨ ì½”ë“œ í’ˆì§ˆ:" ;;
                "suggestions") echo "ğŸ’¡ ì œì•ˆì‚¬í•­:" ;;
                "gh_not_installed") echo "âš ï¸  GitHub CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. PR ì—°ë™ì„ ìœ„í•´ ì„¤ì¹˜í•´ì£¼ì„¸ìš”:
   brew install gh  # ë˜ëŠ” https://cli.github.com ë°©ë¬¸" ;;
                "no_pr_found") echo "ğŸ“ í˜„ì¬ ë¸Œëœì¹˜ì— ëŒ€í•œ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œëœì¹˜ diff ê¸°ë°˜ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤." ;;
                "pr_found") echo "ğŸ“ PR #$param1 ë°œê²¬: $param2" ;;
                "debug_pr_search") echo "ğŸ” ë¸Œëœì¹˜ì— ëŒ€í•œ PR ê²€ìƒ‰ ì¤‘: $param1" ;;
                "posting_comment") echo "ğŸ“ PR ëŒ“ê¸€ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤..." ;;
                "comment_posted") echo "âœ… PRì— ë¦¬ë·° ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!" ;;
                "comment_failed") echo "âŒ PR ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." ;;
                "configure_title") echo "ğŸŒ ì–¸ì–´ ì„¤ì •" ;;
                "configure_current") echo "ğŸ“ í˜„ì¬ ì–¸ì–´: $param1" ;;
                "configure_select") echo "ğŸ”¤ ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš” / Select language:" ;;
                "configure_korean") echo "  1. í•œêµ­ì–´ (Korean)" ;;
                "configure_english") echo "  2. English" ;;
                "configure_prompt") echo "ì„ íƒí•˜ì„¸ìš” (1-2): " ;;
                "configure_success") echo "âœ… ì–¸ì–´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: $param1" ;;
                "configure_invalid") echo "âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. 1 ë˜ëŠ” 2ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”." ;;
                "first_run_title") echo "ğŸ‰ AI PR Review Assistantì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!" ;;
                "first_run_subtitle") echo "ìµœì´ˆ ì„¤ì •" ;;
                "first_run_desc") echo "UIì™€ ë¦¬ë·° ë©”ì‹œì§€ì— ì‚¬ìš©í•  ì–¸ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:" ;;
                *) echo "$key" ;;
            esac
            ;;
    esac
}

# ì–¸ì–´ ì„¤ì • í•¨ìˆ˜
configure_language() {
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BOLD}$(msg "configure_title")${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    
    if [ -n "$LANGUAGE" ]; then
        local current_lang_name
        if [ "$LANGUAGE" = "en" ]; then
            current_lang_name="English"
        else
            current_lang_name="í•œêµ­ì–´"
        fi
        echo -e "${CYAN}$(msg "configure_current" "$current_lang_name")${NC}"
        echo ""
    fi
    
    echo -e "${CYAN}$(msg "configure_select")${NC}"
    echo -e "$(msg "configure_korean")"
    echo -e "$(msg "configure_english")"
    echo ""
    
    while true; do
        read -p "$(msg "configure_prompt")" choice
        case $choice in
            1)
                LANGUAGE="ko"
                save_config "ko"
                echo -e "${GREEN}$(msg "configure_success" "í•œêµ­ì–´")${NC}"
                break
                ;;
            2)
                LANGUAGE="en"
                save_config "en"
                echo -e "${GREEN}$(msg "configure_success" "English")${NC}"
                break
                ;;
            *)
                echo -e "${RED}$(msg "configure_invalid")${NC}"
                ;;
        esac
    done
}

# ìµœì´ˆ ì‹¤í–‰ ì²´í¬ ë° ì–¸ì–´ ì„¤ì •
first_time_setup() {
    echo -e "${MAGENTA}ğŸ‰ Welcome to AI PR Review Assistant!${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BOLD}First-time setup${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    echo -e "${CYAN}Please select your preferred language for UI and review messages:${NC}"
    echo ""
    
    echo -e "  1. í•œêµ­ì–´ (Korean)"
    echo -e "  2. English"
    echo ""
    
    while true; do
        read -p "Select (1-2): " choice
        case $choice in
            1)
                LANGUAGE="ko"
                save_config "ko"
                echo ""
                echo -e "${GREEN}âœ… ì–¸ì–´ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: í•œêµ­ì–´${NC}"
                echo ""
                break
                ;;
            2)
                LANGUAGE="en"
                save_config "en"
                echo ""
                echo -e "${GREEN}âœ… Language set to: English${NC}"
                echo ""
                break
                ;;
            *)
                echo -e "${RED}âŒ Invalid choice. Please select 1 or 2.${NC}"
                ;;
        esac
    done
}

# ë¸Œë¼ì¼ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
show_braille() {
    local pid=$1
    local delay=0.08
    local braille="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    local i=0
    
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r${CYAN}$(msg "ai_reviewing") ${braille:$i:1}${NC}"
        i=$(((i+1) % ${#braille}))
        sleep $delay
    done
    printf "\r${CYAN}$(msg "ai_reviewing") âœ“${NC}\n"
}

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# ì„¤ì • ë¡œë“œ
load_config

# í”Œë˜g ë³€ìˆ˜ ì´ˆê¸°í™”  
TARGET_BRANCH=""
BASE_BRANCH="main"
DIFF_MODE=false
POST_COMMENT=false
PR_NUMBER=""
PR_TITLE=""

# ì¸ì ì²˜ë¦¬
while [[ $# -gt 0 ]]; do
    case $1 in
        --configure)
            if [ -z "$LANGUAGE" ]; then
                first_time_setup
            else
                configure_language
            fi
            exit 0
            ;;
        --diff)
            DIFF_MODE=true
            shift
            if [[ $# -gt 0 && ! $1 =~ ^-- ]]; then
                BASE_BRANCH="$1"
                shift
            fi
            ;;
        --post-comment)
            POST_COMMENT=true
            shift
            ;;
        --version|-v)
            echo "gemini-pr-review-assistant v1.1.4"
            echo "AI-powered PR review and analysis using Gemini CLI"
            echo ""
            echo "Dependencies:"
            echo "  - Node.js >=16.0.0"
            echo "  - @google/gemini-cli >=0.1.0 (required)"
            echo "  - gh (GitHub CLI) - optional for PR integration & comments"
            echo ""
            echo "Repository: https://github.com/geonhwiii/gemini-pr-review-assistant"
            echo "npm: https://www.npmjs.com/package/gemini-pr-review-assistant"
            exit 0
            ;;
        --help|-h)
            # --helpëŠ” ì–¸ì–´ ì„¤ì •ê³¼ ê´€ê³„ì—†ì´ ê¸°ë³¸ ë„ì›€ë§ í‘œì‹œ
            echo -e "${BOLD}ğŸ” AI PR Review CLI - AI-powered pull request review and analysis${NC}"
            echo ""
            echo -e "${CYAN}Usage:${NC}"
            echo -e "  aipr                    # Review current branch PR"
            echo -e "  aipr <branch>           # Review specific branch PR"
            echo -e "  aipr --diff <base>      # Compare with specific base branch"
            echo -e "  aipr --post-comment     # Post review as PR comment"
            echo ""
            echo -e "${CYAN}Options:${NC}"
            echo -e "  <branch>                # Target branch to review"
            echo -e "  --diff <base>           # Compare with base branch (default: main)"
            echo -e "  --post-comment          # Post AI review as GitHub PR comment"
            echo -e "  --configure             # Configure language settings"
            echo -e "  --version, -v           # Show version information"
            echo -e "  --help, -h              # Show help"
            echo ""
            echo -e "${CYAN}Examples:${NC}"
            echo -e "  aipr                    # Review current branch"
            echo -e "  aipr feature/login      # Review feature/login branch"
            echo -e "  aipr --diff develop     # Compare current branch with develop"
            echo -e "  aipr --post-comment     # Review and post comment to PR"
            echo ""
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}"
            echo -e "Usage: aipr [branch] [--diff base] [--post-comment] [--configure] [--version|-v] [--help|-h]"
            exit 1
            ;;
        *)
            TARGET_BRANCH="$1"
            shift
            ;;
    esac
done

# ìµœì´ˆ ì‹¤í–‰ ì²´í¬ (--helpê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
if [ -z "$LANGUAGE" ]; then
    first_time_setup
fi

echo -e "${MAGENTA}$(msg "welcome")${NC}"

# Git ì €ì¥ì†Œ í™•ì¸
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo -e "${RED}$(msg "not_git_repo")${NC}"
    exit 1
fi

# GitHub PR ì •ë³´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
get_pr_info() {
    local branch=$1
    if command -v gh >/dev/null 2>&1; then
        # ë°©ë²• 1: í˜„ì¬ ë¸Œëœì¹˜ì˜ PRì„ ì§ì ‘ ì°¾ê¸°
        if [ "$branch" = "$(git branch --show-current)" ]; then
            PR_INFO=$(gh pr view --json number,title,body 2>/dev/null)
        fi
        
        # ë°©ë²• 1ì´ ì‹¤íŒ¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œëœì¹˜ì¸ ê²½ìš°, head ë¸Œëœì¹˜ë¡œ ê²€ìƒ‰
        if [ -z "$PR_INFO" ] || [ "$PR_INFO" = "null" ]; then
            PR_LIST=$(gh pr list --head "$branch" --json number,title,body --limit 1 2>/dev/null)
            if [ -n "$PR_LIST" ] && [ "$PR_LIST" != "[]" ]; then
                PR_INFO=$(echo "$PR_LIST" | sed 's/^\[\s*//' | sed 's/\s*\]$//' | head -1)
            fi
        fi
        
        # ë°©ë²• 2ë„ ì‹¤íŒ¨í•œ ê²½ìš°, ì›ê²© ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ ì‹œë„
        if [ -z "$PR_INFO" ] || [ "$PR_INFO" = "null" ]; then
            # origin/branch-name í˜•íƒœë¡œ ì‹œë„
            REMOTE_BRANCH="origin/$branch"
            PR_LIST=$(gh pr list --head "$REMOTE_BRANCH" --json number,title,body --limit 1 2>/dev/null)
            if [ -n "$PR_LIST" ] && [ "$PR_LIST" != "[]" ]; then
                PR_INFO=$(echo "$PR_LIST" | sed 's/^\[\s*//' | sed 's/\s*\]$//' | head -1)
            fi
        fi
        
        # PR ì •ë³´ íŒŒì‹±
        if [ -n "$PR_INFO" ] && [ "$PR_INFO" != "null" ] && [ "$PR_INFO" != "[]" ]; then
            PR_NUMBER=$(echo "$PR_INFO" | grep -o '"number":[0-9]*' | cut -d':' -f2)
            PR_TITLE=$(echo "$PR_INFO" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "" ]; then
                return 0
            fi
        fi
    fi
    return 1
}

# PRì— ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜
post_pr_comment() {
    local review_content="$1"
    if [ -n "$PR_NUMBER" ] && command -v gh >/dev/null 2>&1; then
        echo -e "${CYAN}$(msg "posting_comment")${NC}"
        
        # ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ë¦¬ë·° í¬ë§·íŒ…
        local formatted_review="## ğŸ¤– AI Code Review

$review_content

---
*Generated by [gemini-pr-review-assistant](https://www.npmjs.com/package/gemini-pr-review-assistant)*"
        
        if gh pr comment "$PR_NUMBER" --body "$formatted_review" >/dev/null 2>&1; then
            echo -e "${GREEN}$(msg "comment_posted")${NC}"
            return 0
        else
            echo -e "${RED}$(msg "comment_failed")${NC}"
            return 1
        fi
    fi
    return 1
}

# Gemini CLI ì„¤ì¹˜ í™•ì¸
if ! command -v gemini >/dev/null 2>&1; then
    echo -e "${YELLOW}$(msg "gemini_not_installed")${NC}"
    exit 1
fi

# GitHub CLI ì„¤ì¹˜ í™•ì¸ (ì˜µì…˜)
if [ "$POST_COMMENT" = true ] && ! command -v gh >/dev/null 2>&1; then
    echo -e "${YELLOW}$(msg "gh_not_installed")${NC}"
    echo ""
fi

# í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
if [ -z "$TARGET_BRANCH" ]; then
    # ë°©ë²• 1: git branch --show-current (Git 2.22+)
    CURRENT_BRANCH=$(git branch --show-current 2>/dev/null)
    
    # ë°©ë²• 1ì´ ì‹¤íŒ¨í•œ ê²½ìš° ë°©ë²• 2: git rev-parse (ë” í˜¸í™˜ì„± ìˆìŒ)
    if [ -z "$CURRENT_BRANCH" ]; then
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
    fi
    
    # ë°©ë²• 2ë„ ì‹¤íŒ¨í•œ ê²½ìš° ë°©ë²• 3: git branch
    if [ -z "$CURRENT_BRANCH" ]; then
        CURRENT_BRANCH=$(git branch 2>/dev/null | grep "^\*" | cut -d' ' -f2-)
    fi
    
    # ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•œ ê²½ìš° ê¸°ë³¸ê°’
    if [ -z "$CURRENT_BRANCH" ]; then
        CURRENT_BRANCH="unknown-branch"
    fi
    
    TARGET_BRANCH="$CURRENT_BRANCH"
fi

# DEBUG: ë¸Œëœì¹˜ ì •ë³´ ì¶œë ¥
echo -e "${YELLOW}[DEBUG] TARGET_BRANCH value: '$TARGET_BRANCH'${NC}"
echo -e "${YELLOW}[DEBUG] git branch --show-current: '$(git branch --show-current 2>/dev/null)'${NC}"
echo -e "${YELLOW}[DEBUG] git rev-parse --abbrev-ref HEAD: '$(git rev-parse --abbrev-ref HEAD 2>/dev/null)'${NC}"

echo -e "${CYAN}$(msg "current_branch" "$TARGET_BRANCH")${NC}"

# PR ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
echo -e "${YELLOW}[DEBUG] Checking GitHub CLI availability...${NC}"
if command -v gh >/dev/null 2>&1; then
    echo -e "${YELLOW}[DEBUG] GitHub CLI found, checking authentication...${NC}"
    gh auth status 2>/dev/null || echo -e "${YELLOW}[DEBUG] GitHub CLI not authenticated${NC}"
    
    echo -e "${YELLOW}[DEBUG] Searching for PR with branch: '$TARGET_BRANCH'${NC}"
    echo -e "${YELLOW}[DEBUG] Method 1 - gh pr view (current branch):${NC}"
    gh pr view --json number,title,body 2>&1 | head -3
    
    echo -e "${YELLOW}[DEBUG] Method 2 - gh pr list --head '$TARGET_BRANCH':${NC}"
    gh pr list --head "$TARGET_BRANCH" --json number,title,body --limit 1 2>&1 | head -3
    
    echo -e "${YELLOW}[DEBUG] Method 3 - gh pr list --head 'origin/$TARGET_BRANCH':${NC}"
    gh pr list --head "origin/$TARGET_BRANCH" --json number,title,body --limit 1 2>&1 | head -3
else
    echo -e "${YELLOW}[DEBUG] GitHub CLI not found${NC}"
fi

if get_pr_info "$TARGET_BRANCH"; then
    echo -e "${CYAN}$(msg "pr_found" "$PR_NUMBER" "$PR_TITLE")${NC}"
else
    echo -e "${YELLOW}$(msg "no_pr_found")${NC}"
fi

# ì°¨ì´ì  ë¶„ì„
if [ "$DIFF_MODE" = true ]; then
    echo -e "${CYAN}$(msg "analyzing_diff" "$TARGET_BRANCH" "$BASE_BRANCH")${NC}"
    DIFF_OUTPUT=$(git diff "$BASE_BRANCH".."$TARGET_BRANCH" 2>/dev/null)
else
    echo -e "${CYAN}$(msg "analyzing_branch")${NC}"
    DIFF_OUTPUT=$(git diff "$BASE_BRANCH".."$TARGET_BRANCH" 2>/dev/null)
fi

# ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
if [ -z "$DIFF_OUTPUT" ]; then
    echo -e "${YELLOW}$(msg "no_changes")${NC}"
    exit 1
fi

# Git ë¡œê·¸ ë° íŒŒì¼ ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘
COMMIT_LOG=$(git log "$BASE_BRANCH".."$TARGET_BRANCH" --oneline --no-merges | head -10)
FILE_CHANGES=$(git diff --name-status "$BASE_BRANCH".."$TARGET_BRANCH")

# ì–¸ì–´ë³„ Gemini í”„ë¡¬í”„íŠ¸ ìƒì„±
PR_INFO_TEXT=""
if [ -n "$PR_NUMBER" ]; then
    PR_INFO_TEXT="PR #$PR_NUMBER: $PR_TITLE"
else
    PR_INFO_TEXT="Branch comparison (no PR found)"
fi

if [ "$LANGUAGE" = "en" ]; then
    REVIEW_PROMPT="You are an expert code reviewer. Analyze this pull request and provide a comprehensive review.

PULL REQUEST ANALYSIS:

$PR_INFO_TEXT
Target Branch: $TARGET_BRANCH
Base Branch: $BASE_BRANCH

COMMIT HISTORY:
$COMMIT_LOG

FILE CHANGES:
$FILE_CHANGES

CODE DIFF:
$(echo "$DIFF_OUTPUT" | head -100)

Please provide a detailed review covering:

1. **Security Issues**: Any potential security vulnerabilities
2. **Performance Issues**: Performance concerns and optimization opportunities  
3. **Code Quality**: Code structure, readability, maintainability
4. **Best Practices**: Adherence to coding standards and best practices
5. **Suggestions**: Specific improvement recommendations

Format your response with clear sections and bullet points for easy reading.
Use English language for the review."
else
    REVIEW_PROMPT="ë‹¹ì‹ ì€ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ì´ í’€ ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ê³  í¬ê´„ì ì¸ ë¦¬ë·°ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.

í’€ ë¦¬í€˜ìŠ¤íŠ¸ ë¶„ì„:

$PR_INFO_TEXT
ëŒ€ìƒ ë¸Œëœì¹˜: $TARGET_BRANCH
ë² ì´ìŠ¤ ë¸Œëœì¹˜: $BASE_BRANCH

ì»¤ë°‹ íˆìŠ¤í† ë¦¬:
$COMMIT_LOG

íŒŒì¼ ë³€ê²½ì‚¬í•­:
$FILE_CHANGES

ì½”ë“œ ì°¨ì´ì :
$(echo "$DIFF_OUTPUT" | head -100)

ë‹¤ìŒ í•­ëª©ë“¤ì„ í¬í•¨í•œ ìì„¸í•œ ë¦¬ë·°ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”:

1. **ë³´ì•ˆ ì´ìŠˆ**: ì ì¬ì ì¸ ë³´ì•ˆ ì·¨ì•½ì 
2. **ì„±ëŠ¥ ì´ìŠˆ**: ì„±ëŠ¥ ë¬¸ì œ ë° ìµœì í™” ê¸°íšŒ
3. **ì½”ë“œ í’ˆì§ˆ**: ì½”ë“œ êµ¬ì¡°, ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±
4. **ëª¨ë²” ì‚¬ë¡€**: ì½”ë”© í‘œì¤€ ë° ëª¨ë²” ì‚¬ë¡€ ì¤€ìˆ˜
5. **ì œì•ˆì‚¬í•­**: êµ¬ì²´ì ì¸ ê°œì„  ê¶Œì¥ì‚¬í•­

ëª…í™•í•œ ì„¹ì…˜ê³¼ ë¶ˆë¦¿ í¬ì¸íŠ¸ë¡œ ì½ê¸° ì‰½ê²Œ í˜•ì‹ì„ ë§ì¶°ì£¼ì„¸ìš”.
ë¦¬ë·°ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."
fi

# Gemini CLI í˜¸ì¶œ
AI_REVIEW=""
TEMP_OUTPUT="/tmp/gemini_pr_review_$$"
(gemini --model gemini-2.5-flash --prompt "$REVIEW_PROMPT" 2>&1 > "$TEMP_OUTPUT"; echo $? > "/tmp/gemini_pr_exit_$$") &
GEMINI_PID=$!

# ë¸Œë¼ì¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
show_braille $GEMINI_PID

# í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ ëŒ€ê¸°
wait $GEMINI_PID

# ê²°ê³¼ ì½ê¸°
GEMINI_OUTPUT=$(cat "$TEMP_OUTPUT")
GEMINI_EXIT_CODE=$(cat "/tmp/gemini_pr_exit_$$")

# ì„ì‹œ íŒŒì¼ ì •ë¦¬
rm -f "$TEMP_OUTPUT" "/tmp/gemini_pr_exit_$$"

# Gemini CLI ì‹¤í–‰ ê²°ê³¼ ì²˜ë¦¬
if [ $GEMINI_EXIT_CODE -eq 0 ]; then
    # "Loaded cached credentials." ì œê±°í•˜ê³  ì˜ë¯¸ìˆëŠ” ì¶œë ¥ ì¶”ì¶œ
    AI_REVIEW=$(echo "$GEMINI_OUTPUT" | grep -v "Loaded cached credentials" | grep -v "^$" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    
    echo ""
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${GREEN}$(msg "ai_review_complete")${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo ""
    echo -e "${BOLD}$AI_REVIEW${NC}"
    echo ""
    echo -e "${BLUE}============================================================${NC}"
    
    # PR ëŒ“ê¸€ ì‘ì„± (ìš”ì²­ëœ ê²½ìš°)
    if [ "$POST_COMMENT" = true ]; then
        if [ -n "$PR_NUMBER" ] && command -v gh >/dev/null 2>&1; then
            echo ""
            post_pr_comment "$AI_REVIEW"
        else
            if [ -z "$PR_NUMBER" ]; then
                echo -e "${YELLOW}âš ï¸  No PR found for current branch. Cannot post comment.${NC}"
            elif ! command -v gh >/dev/null 2>&1; then
                echo -e "${YELLOW}$(msg "gh_not_installed")${NC}"
            fi
        fi
    fi
else
    echo -e "${RED}Failed to get AI review. Exit code: $GEMINI_EXIT_CODE${NC}"
    exit 1
fi